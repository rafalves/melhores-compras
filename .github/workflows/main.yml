name: Nuxt Melhores-Compras.Online - CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # - name: Install npm dependencies
      #   run: npm install

      # - name: Run build task
      #   run: npm run build

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc -i --delete" #//delete all files that aren't in the github source (.env will be deleted if this is -- delete is enabled)
          SOURCE: "/"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: "/home/rafael/melhores-compras/"
          # EXCLUDE: "/.cache/, .editorconfig, .env.example, .eslintignore, .eslintrc, /.git/, /.github/, .gitignore, .strapi-updater.json, README.md, /build/, /config/, /database/, favicon.png, local_ssh_script-before.sh, /node_modules/, package.json, package-lock.json, /public/, strapiloader.js, yarn.lock"
          # EXCLUDE: ""
          SCRIPT_BEFORE: |
            echo "SCRIPT_BEFORE"
            echo "ðŸš€ðŸš€ðŸš€ STOP PM2 ðŸš€ðŸš€ðŸš€"
            echo "pm2 delete nuxtapp-mecomprs"
            pm2 delete nuxtapp-mecomprs
            echo "pm2 status" 
            pm2 status
          SCRIPT_AFTER: |
            echo "SCRIPT_AFTER"
            echo "ðŸš€ðŸš€ðŸš€ CD to Folder ðŸš€ðŸš€ðŸš€"
            echo "cd melhores-compras/"
            cd melhores-compras/
            echo"npm install"
            npm install
            echo "npm run build"
            npm run build
            echo "ðŸš€ðŸš€ðŸš€ Runnin PM2 - nuxtapp-mecomprs ðŸš€ðŸš€ðŸš€"
            echo "pm2 start ecosystem.config.js"
            pm2 start ecosystem.config.js
            echo "pm2 status"
            pm2 status
            echo $RSYNC_STDOUT
